generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Department {
  id           String   @id @default(cuid())
  code         String   @unique
  name         String
  displayOrder Int

  kpiDefinitions  KpiDefinition[]
  reportTemplates ReportTemplate[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model RulesetType {
  id          String  @id
  name        String
  description String
  logic       String
  isScored    Boolean @default(true)

  kpiDefinitions   KpiDefinition[]
  thresholdConfigs RulesetThresholdConfig[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model KpiDefinition {
  id             String     @id @default(cuid())
  kpiCode        String     @unique
  kpiName        String
  csvDescription String

  departmentId   String
  department     Department @relation(fields: [departmentId], references: [id])

  rulesetTypeId  String
  rulesetType    RulesetType @relation(fields: [rulesetTypeId], references: [id])

  dataFormat     DataFormat @default(PERCENTAGE)
  higherIsBetter Boolean    @default(true)
  benchmarkMin   Float?
  benchmarkMax   Float?
  displayOrder   Int

  kpiValues       KpiValue[]
  benchmarkValues BenchmarkValue[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([departmentId])
  @@index([rulesetTypeId])
}

enum DataFormat {
  PERCENTAGE
  CURRENCY
  RATIO
  NUMBER
  SCORE
}

model RulesetThresholdConfig {
  id            String      @id @default(cuid())
  rulesetTypeId String
  rulesetType   RulesetType @relation(fields: [rulesetTypeId], references: [id])
  thresholds    Json
  isActive      Boolean     @default(true)
  version       Int         @default(1)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([rulesetTypeId])
}

model Dealer {
  id         String   @id @default(cuid())
  dealerCode String   @unique
  dealerName String

  dealerUploads DealerUpload[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// --- New session-based models ---

enum SessionStatus {
  PENDING
  EXTRACTING
  READY
  COMPLETED
  FAILED
}

enum UploadStatus {
  PENDING
  EXTRACTING
  EXTRACTED
  FAILED
}

enum ReportRunStatus {
  PENDING
  GENERATING
  COMPLETED
  FAILED
}

model UploadSession {
  id     String        @id @default(cuid())
  name   String?
  userId String?
  status SessionStatus @default(PENDING)

  dealerUploads      DealerUpload[]
  benchmarkSnapshots BenchmarkSnapshot[]
  reportRuns         ReportRun[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([createdAt])
  @@index([userId])
}

model DealerUpload {
  id              String       @id @default(cuid())
  uploadSessionId String
  uploadSession   UploadSession @relation(fields: [uploadSessionId], references: [id], onDelete: Cascade)
  dealerId        String
  dealer          Dealer       @relation(fields: [dealerId], references: [id])
  periodStart     DateTime
  periodEnd       DateTime
  rawCsvData      String       @db.Text
  status          UploadStatus @default(PENDING)
  errorMessage    String?

  kpiValues KpiValue[]
  reports   Report[]

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  processedAt DateTime?

  @@unique([uploadSessionId, dealerId])
  @@index([uploadSessionId])
  @@index([dealerId])
}

model BenchmarkSnapshot {
  id              String        @id @default(cuid())
  uploadSessionId String
  uploadSession   UploadSession @relation(fields: [uploadSessionId], references: [id], onDelete: Cascade)
  periodStart     DateTime
  periodEnd       DateTime

  benchmarkValues BenchmarkValue[]

  createdAt DateTime @default(now())

  @@unique([uploadSessionId, periodStart, periodEnd])
  @@index([uploadSessionId])
}

model BenchmarkValue {
  id                  String            @id @default(cuid())
  benchmarkSnapshotId String
  benchmarkSnapshot   BenchmarkSnapshot @relation(fields: [benchmarkSnapshotId], references: [id], onDelete: Cascade)
  kpiDefinitionId     String
  kpiDefinition       KpiDefinition     @relation(fields: [kpiDefinitionId], references: [id])

  bClassAverage     Float?
  bClassYoyChange   Float?
  nationalAverage   Float?
  nationalYoyChange Float?

  @@unique([benchmarkSnapshotId, kpiDefinitionId])
  @@index([benchmarkSnapshotId])
  @@index([kpiDefinitionId])
}

model ReportRun {
  id              String          @id @default(cuid())
  uploadSessionId String
  uploadSession   UploadSession   @relation(fields: [uploadSessionId], references: [id], onDelete: Cascade)
  commentaryStyle CommentaryStyle @default(STANDARD)
  templateCodes   String[]
  status          ReportRunStatus @default(PENDING)

  reports Report[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([uploadSessionId])
}

enum CommentaryStyle {
  EXECUTIVE
  STANDARD
  DETAILED
  COACHING
  DIRECT
}

model KpiValue {
  id              String       @id @default(cuid())
  dealerUploadId  String
  dealerUpload    DealerUpload @relation(fields: [dealerUploadId], references: [id], onDelete: Cascade)
  kpiDefinitionId String
  kpiDefinition   KpiDefinition @relation(fields: [kpiDefinitionId], references: [id])

  currentValue      Float
  priorYearValue    Float?
  yoyChangeAbsolute Float?
  yoyChangePercent  Float?
  percentOfBClass   Float?
  percentOfNational Float?
  benchmarkScore    BenchmarkScore?

  createdAt DateTime @default(now())

  @@unique([dealerUploadId, kpiDefinitionId])
  @@index([dealerUploadId])
  @@index([kpiDefinitionId])
}

enum BenchmarkScore {
  EXCEPTIONAL
  EXCELLENT
  GREAT
  GOOD
  ACCEPTABLE
  WEAK
  SUBSTANDARD
  POOR
  NA
}

model ReportTemplate {
  id           String     @id @default(cuid())
  reportCode   String     @unique
  reportId     String
  title        String
  departmentId String
  department   Department @relation(fields: [departmentId], references: [id])
  kpiCodes     String[]

  reports Report[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Report {
  id             String        @id @default(cuid())
  reportRunId    String
  reportRun      ReportRun     @relation(fields: [reportRunId], references: [id], onDelete: Cascade)
  dealerUploadId String
  dealerUpload   DealerUpload  @relation(fields: [dealerUploadId], references: [id], onDelete: Cascade)
  templateId     String
  template       ReportTemplate @relation(fields: [templateId], references: [id])

  aiAssessment  Json?
  documentPath  String?
  documentSize  Int?
  status        ReportStatus @default(PENDING)
  generatedAt   DateTime?
  errorMessage  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([reportRunId, dealerUploadId, templateId])
  @@index([reportRunId])
  @@index([dealerUploadId])
  @@index([status])
}

enum ReportStatus {
  PENDING
  GENERATING
  COMPLETED
  FAILED
}
